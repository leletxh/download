name: Download and Push Files

on:
  workflow_dispatch:
    inputs:
      url:
        description: 'URL to a text file containing one file URL per line'
        required: true
        type: string

permissions:
  contents: write  # 允许推送内容到仓库

jobs:
  download-and-push:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          pip install requests

      - name: Download file list
        run: |
          curl -s -o filelist.txt "${{ github.event.inputs.url }}"

      - name: Download files in parallel and push
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          import os
          import sys
          import requests
          from concurrent.futures import ThreadPoolExecutor, as_completed

          # 读取文件列表
          with open('filelist.txt', 'r') as f:
              urls = [line.strip() for line in f if line.strip()]

          if not urls:
              print("No URLs found in file list.")
              sys.exit(0)

          def download_file(url):
              try:
                  print(f"Downloading: {url}")
                  response = requests.get(url, stream=True)
                  response.raise_for_status()

                  # 从 URL 提取文件名（安全处理）
                  filename = os.path.basename(url.split('?')[0])
                  if not filename:
                      filename = f"file_{hash(url) & 0xFFFF}.bin"
                  safe_filename = "".join(c if c.isalnum() or c in "._-" else "_" for c in filename)

                  with open(safe_filename, 'wb') as out_file:
                      for chunk in response.iter_content(chunk_size=8192):
                          out_file.write(chunk)
                  print(f"Saved as: {safe_filename}")
                  return safe_filename
              except Exception as e:
                  print(f"Failed to download {url}: {e}")
                  return None

          # 并行下载
          downloaded_files = []
          with ThreadPoolExecutor(max_workers=10) as executor:
              futures = {executor.submit(download_file, url): url for url in urls}
              for future in as_completed(futures):
                  result = future.result()
                  if result:
                      downloaded_files.append(result)

          if not downloaded_files:
              print("No files were successfully downloaded.")
              sys.exit(0)

          # 配置 Git
          os.system('git config --global user.name "github-actions[bot]"')
          os.system('git config --global user.email "github-actions[bot]@users.noreply.github.com"')

          # 添加、提交、推送
          for f in downloaded_files:
              os.system(f'git add "{f}"')
          os.system('git commit -m "Add downloaded files via GitHub Action"')
          os.system('git push')

        shell: python

      - name: Summary
        if: always()
        run: |
          echo "Workflow completed."
