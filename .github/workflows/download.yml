name: Download and Push Files

on:
  workflow_dispatch:
    inputs:
      url:
        description: 'URL to a plain text file containing one file URL per line (must be UTF-8 or ASCII)'
        required: true
        type: string

permissions:
  contents: write

jobs:
  download-and-push:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          pip install requests chardet

      - name: Download file list
        run: |
          curl -s -o filelist.txt "${{ github.event.inputs.url }}"

      - name: Download files in parallel and push
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          import os
          import sys
          import requests
          import chardet
          from concurrent.futures import ThreadPoolExecutor, as_completed

          # 检测文件编码
          with open('filelist.txt', 'rb') as raw_f:
              raw_data = raw_f.read()
              if len(raw_data) == 0:
                  print("Error: Downloaded file list is empty.")
                  sys.exit(1)
              encoding = chardet.detect(raw_data)['encoding']
              # 保守处理：若非 UTF-8/ASCII，尝试 fallback
              if encoding is None or 'utf' not in encoding.lower():
                  encoding = 'utf-8'

          try:
              text = raw_data.decode(encoding, errors='ignore')
          except Exception as e:
              print(f"Error decoding file list (detected encoding: {encoding}): {e}")
              print("Please ensure the input URL points to a plain text file with one URL per line (UTF-8 preferred).")
              sys.exit(1)

          urls = [line.strip() for line in text.splitlines() if line.strip() and line.strip().startswith(('http://', 'https://'))]

          if not urls:
              print("No valid HTTP/HTTPS URLs found in the file list.")
              sys.exit(1)

          print(f"Found {len(urls)} URLs to download.")

          def download_file(url):
              try:
                  print(f"Downloading: {url}")
                  response = requests.get(url, stream=True, timeout=30)
                  response.raise_for_status()

                  filename = os.path.basename(url.split('?')[0].split('/')[-1])
                  if not filename or '.' not in filename:
                      # 生成安全默认名
                      filename = f"downloaded_file_{abs(hash(url)) % 10000:04d}"
                  # 清理非法字符
                  safe_filename = "".join(c if c.isalnum() or c in "._-" else "_" for c in filename)
                  # 防止覆盖
                  counter = 1
                  orig = safe_filename
                  while os.path.exists(safe_filename):
                      safe_filename = f"{orig}_{counter}"
                      counter += 1

                  with open(safe_filename, 'wb') as out_file:
                      for chunk in response.iter_content(chunk_size=8192):
                          if chunk:
                              out_file.write(chunk)
                  print(f"Saved as: {safe_filename}")
                  return safe_filename
              except Exception as e:
                  print(f"Failed to download {url}: {e}")
                  return None

          downloaded_files = []
          with ThreadPoolExecutor(max_workers=5) as executor:
              futures = {executor.submit(download_file, url): url for url in urls}
              for future in as_completed(futures):
                  result = future.result()
                  if result:
                      downloaded_files.append(result)

          if not downloaded_files:
              print("No files were successfully downloaded.")
              sys.exit(1)

          # Git config
          os.system('git config --global user.name "github-actions[bot]"')
          os.system('git config --global user.email "github-actions[bot]@users.noreply.github.com"')

          # Add, commit, push
          for f in downloaded_files:
              os.system(f'git add "{f}"')
          os.system('git commit -m "Add downloaded files via GitHub Action"')
          os.system('git push')

        shell: python
